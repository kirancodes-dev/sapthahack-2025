<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Participant Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- GOLD & NAVY THEME --- */
        :root { --navy: #003366; --gold: #FFCC00; --light: #f8f9fa; }
        
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        .navbar { background: var(--navy) !important; border-bottom: 4px solid var(--gold); }
        .text-navy { color: var(--navy); }
        .text-gold { color: var(--gold); }
        
        .btn-navy { background: var(--navy); color: #fff; border: 2px solid var(--navy); padding: 10px 25px; font-weight: 600; }
        .btn-navy:hover { background: #fff; color: var(--navy); }
        
        .btn-gold { background: var(--gold); color: #003366; border: 2px solid var(--gold); padding: 10px 25px; font-weight: 700; }
        .btn-gold:hover { background: #fff; }

        /* DASHBOARD CARDS */
        .dashboard-card { 
            border-radius: 20px; border: none; background: #fff; 
            box-shadow: 0 10px 30px rgba(0,51,102,0.1); 
            transition: transform 0.3s; overflow: hidden;
        }
        .dashboard-card:hover { transform: translateY(-5px); }
        
        /* RANKING CIRCLE */
        .rank-circle {
            width: 120px; height: 120px; border-radius: 50%; 
            background: linear-gradient(135deg, var(--gold), #ffdb4d);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; font-weight: bold; color: var(--navy);
            margin: 0 auto 20px; border: 5px solid #fff; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .form-section { display: none; animation: fadeIn 0.5s; }
        .form-section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

{% if view == 'dashboard' %}
    <nav class="navbar navbar-dark px-4 shadow">
        <span class="navbar-brand fw-bold"><i class="fas fa-graduation-cap me-2"></i>Student Dashboard</span>
        <a href="/participant/logout" class="btn btn-outline-light btn-sm rounded-pill px-3">Logout</a>
    </nav>

    <div class="container mt-5">
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="dashboard-card p-4 text-center h-100 position-relative">
                    <h6 class="text-muted fw-bold mb-4">CURRENT STANDING</h6>
                    
                    {% if team.rank == 1 %}
                        <div class="rank-circle"><i class="fas fa-trophy"></i></div>
                        <h2 class="text-navy fw-bold">WINNER!</h2>
                        <span class="badge bg-success fs-6 rounded-pill">1st Place</span>
                    {% elif team.status == 'Evaluated' %}
                        <div class="rank-circle">#{{ team.rank }}</div>
                        <h3 class="text-navy">Rank {{ team.rank }}</h3>
                        <p class="text-muted">Score: <b>{{ team.score }}</b> / 30</p>
                    {% else %}
                        <div class="rank-circle" style="background:#e2e8f0; color:#aaa;">?</div>
                        <h4 class="text-muted">Pending</h4>
                        <p class="small text-muted">Judges are reviewing...</p>
                    {% endif %}
                </div>
            </div>

            <div class="col-md-8">
                <div class="dashboard-card p-5">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2 class="text-navy fw-bold m-0">{{ team.team_name }}</h2>
                        <span class="badge bg-warning text-dark fs-6">{{ team.team_id }}</span>
                    </div>
                    <hr>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <small class="text-muted fw-bold">PROBLEM STATEMENT</small>
                            <p class="fs-5">{{ team.problem_statement }}</p>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted fw-bold">SUBMISSIONS</small>
                            <div class="mt-1">
                                {% if team.ppt_file != 'N/A' %} <span class="badge bg-success"><i class="fas fa-check"></i> PPT</span> 
                                {% else %} <span class="badge bg-danger">No PPT</span> {% endif %}
                                
                                {% if team.report_file != 'N/A' %} <span class="badge bg-success"><i class="fas fa-check"></i> Report</span> 
                                {% else %} <span class="badge bg-danger">No Report</span> {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="text-navy border-bottom pb-2 mb-3">Team Members</h5>
                    {% for m in team.members %}
                        <div class="d-flex justify-content-between py-2 align-items-center">
                            <div>
                                <span class="fw-bold">{{ m.name }}</span> 
                                <span class="badge bg-light text-dark border ms-2">{{ m.role }}</span>
                            </div>
                            <span class="text-muted font-monospace">{{ m.id }}</span>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

{% else %}
    <div class="container mt-5 mb-5">
        <div class="text-center mb-5">
            <h1 class="fw-bold display-5" style="color:var(--navy);">SAPTHAHACK PORTAL</h1>
            <p class="text-muted lead">Showcase your innovation to the world.</p>
        </div>

        <div class="d-flex justify-content-center gap-3 mb-4">
            <button onclick="switchTab('login')" class="btn btn-navy px-5 rounded-pill shadow-sm">Login</button>
            <button onclick="switchTab('register')" class="btn btn-gold px-5 rounded-pill shadow-sm">Register Team</button>
        </div>

        <div id="loginForm" class="form-section active mx-auto dashboard-card p-5" style="max-width:450px;">
            <h3 class="text-center text-navy mb-4 fw-bold">Welcome Back</h3>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} py-2 text-center">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form action="/participant/login" method="POST">
                <input type="email" name="email" class="form-control mb-3 p-3 bg-light" placeholder="Lead Email" required>
                <input type="password" name="password" class="form-control mb-4 p-3 bg-light" placeholder="Password" required>
                <button class="btn btn-navy w-100 py-3 fw-bold rounded-pill">ENTER DASHBOARD</button>
            </form>
        </div>

        <div id="regForm" class="form-section mx-auto dashboard-card p-5" style="max-width:800px;">
            <div class="text-center mb-4">
                <h3 class="text-navy fw-bold">New Team Registration</h3>
                {% if event.event_mode == 'hackathon' %}
                    <span class="badge bg-warning text-dark"><i class="fas fa-code"></i> Hackathon Mode</span>
                {% else %}
                    <span class="badge bg-info"><i class="fas fa-calendar"></i> General Event</span>
                {% endif %}
            </div>
            
            <form action="/participant/register" method="POST" enctype="multipart/form-data">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold small text-muted">TEAM NAME</label>
                        <input type="text" name="team_name" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold small text-muted">LEAD NAME</label>
                        <input type="text" name="lead_name" class="form-control" required>
                    </div>
                </div>

                {% if event.event_mode == 'hackathon' %}
                <div class="mb-4">
                    <label class="fw-bold small text-danger">PROBLEM STATEMENT</label>
                    <input type="text" name="problem_statement" class="form-control border-danger" placeholder="Enter Problem ID or Title" required>
                </div>
                {% endif %}

                <div class="p-4 bg-light rounded mb-4 border">
                    <h6 class="text-navy fw-bold mb-3"><i class="fas fa-cloud-upload-alt me-2"></i>Submissions</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="small fw-bold">Presentation (PPT/PDF)</label>
                            <input type="file" name="ppt_file" class="form-control" accept=".pdf,.ppt,.pptx" required>
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold">Project Report (PDF)</label>
                            <input type="file" name="report_file" class="form-control" accept=".pdf" required>
                        </div>
                    </div>
                </div>

                <h5 class="text-navy mb-3 border-bottom pb-2">Team Members</h5>
                
                <div id="membersContainer">
                    {% for i in range(1, 6) %}
                    <div class="row mb-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" name="member_name_{{i}}" class="form-control form-control-sm" placeholder="Member {{i}} Name">
                        </div>
                        
                        <div class="col-md-3">
                            {% if event.team_config.composition == 'student' %}
                                <input type="text" name="member_role_{{i}}" class="form-control form-control-sm bg-light" value="Student" readonly>
                            {% elif event.team_config.composition == 'staff' %}
                                <input type="text" name="member_role_{{i}}" class="form-control form-control-sm bg-light" value="Staff" readonly>
                            {% else %}
                                <select name="member_role_{{i}}" class="form-select form-select-sm member-role-select" data-index="{{i}}">
                                    <option value="Student">Student</option>
                                    <option value="Staff">Staff</option>
                                </select>
                            {% endif %}
                        </div>

                        <div class="col-md-5">
                            <input type="text" name="member_id_{{i}}" id="id_field_{{i}}" class="form-control form-control-sm" 
                                   placeholder="{% if event.team_config.composition == 'staff' %}Enter Staff ID{% else %}Enter SRN{% endif %}">
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="mt-4 p-4 rounded" style="background: #eef2ff; border: 1px dashed var(--navy);">
                    <label class="fw-bold small text-navy">EMAIL VERIFICATION</label>
                    <div class="input-group mb-2">
                        <input type="email" id="regEmail" name="lead_email" class="form-control" placeholder="Lead Email" required>
                        <button type="button" onclick="sendOTP()" class="btn btn-navy">Send OTP</button>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <input type="text" name="otp" class="form-control" placeholder="Enter OTP" required>
                        </div>
                        <div class="col-md-6">
                            <input type="password" name="password" class="form-control" placeholder="Create Password" required>
                        </div>
                    </div>
                </div>

                <button class="btn btn-gold w-100 mt-4 py-3 rounded-pill shadow">REGISTER TEAM</button>
            </form>
        </div>
    </div>

    <script>
        function switchTab(t) {
            document.getElementById('loginForm').classList.toggle('active', t==='login');
            document.getElementById('regForm').classList.toggle('active', t==='register');
        }
        
        // Dynamic Placeholder Logic for "Both" mode
        function updatePlaceholder(select, index) {
            let input = document.getElementById('id_field_' + index);
            if (select.value === 'Student') input.placeholder = "Enter SRN";
            else input.placeholder = "Enter Staff ID";
        }

        // attach change listeners to selects added above (avoids inline Jinja in JS)
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.member-role-select').forEach(function(el) {
                el.addEventListener('change', function() {
                    updatePlaceholder(this, this.dataset.index);
                });
            });
        });

        function sendOTP() {
            let email = document.getElementById('regEmail').value;
            if(!email.includes('@')) { alert("Enter valid email"); return; }
            
            fetch('/participant/send-otp', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email: email})
            }).then(r => r.json()).then(d => alert(d.message));
        }
    </script>
{% endif %}
</body>
</html>